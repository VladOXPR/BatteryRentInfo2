<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battery Rental Status</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        #output {
            margin: 20px 0;
        }
        .view-locations-btn {
            display: inline-block;
            padding: 10px 20px;
            font-size: 16px;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
        .view-locations-btn:hover {
            background-color: #0056b3;
        }
        #batteryIdDisplay {
            margin-top: 30px;
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }
    </style>
</head>
<body>
<h1>CUUB</h1>
<div id="output"></div>
<button class="view-locations-btn" onclick="window.location.href='https://cuublocations.glide.page/dl/d0a5f4';">
    View Locations
</button>
<p id="batteryIdDisplay"></p>

<script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.4.4/luxon.min.js"></script>
<script>
    const { DateTime } = luxon;
    let borrowTime = null;

    function convertChinaToChicagoTime(chinaTimeStr) {
        return chinaTimeStr ? DateTime.fromISO(chinaTimeStr, { zone: "Asia/Shanghai" }).setZone("America/Chicago") : null;
    }

    function getTimeElapsed(startTime) {
        if (!startTime) return "Invalid Time";
        const diff = DateTime.now().setZone("America/Chicago").diff(startTime, ['hours', 'minutes', 'seconds']);
        return `${diff.hours}:${diff.minutes}:${Math.floor(diff.seconds)}`;
    }

    function calculateAmountPaid(startTime) {
        if (!startTime) return "$0.00";
        return `$${(Math.ceil(DateTime.now().diff(startTime, 'hours').hours) * 3).toFixed(2)}`;
    }

    function updateElapsedTime() {
        if (borrowTime) {
            document.getElementById("elapsedTime").textContent = getTimeElapsed(borrowTime);
            document.getElementById("amountPaid").textContent = calculateAmountPaid(borrowTime);
        }
    }

    async function fetchBatteryData() {
        const batteryId = window.location.pathname.substring(1);
        const outputDiv = document.getElementById("output");
        const batteryIdDisplay = document.getElementById("batteryIdDisplay");

        if (!batteryId) {
            outputDiv.innerHTML = "<p><strong>No Battery ID provided in URL.</strong></p>";
            batteryIdDisplay.textContent = "";
            return;
        }

        batteryIdDisplay.textContent = `${batteryId}`;
        const host = window.location.hostname;
        const port = window.location.port ? `:${window.location.port}` : '';
        const apiUrl = `http://${host}${port}/api/battery/${batteryId}`;

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error("Battery not found.");

            const data = await response.json();
            outputDiv.innerHTML = "";

            if (data.pGhtime) {
                const chiReturnTime = convertChinaToChicagoTime(data.pGhtime);
                outputDiv.innerHTML = `<p><strong>Battery Returned:</strong> ${chiReturnTime ? chiReturnTime.toFormat("yyyy-MM-dd HH:mm:ss") : "Invalid Return Time"}</p>`;
            } else {
                borrowTime = convertChinaToChicagoTime(data.pBorrowtime);
                if (borrowTime) {
                    outputDiv.innerHTML = `
                            <p><strong>Rent Duration:</strong> <span id="elapsedTime">${getTimeElapsed(borrowTime)}</span></p>
                            <p><strong>Paid:</strong> <span id="amountPaid">${calculateAmountPaid(borrowTime)}</span></p>
                        `;
                } else {
                    outputDiv.innerHTML = `<p><strong>Invalid Borrow Time</strong></p>`;
                }
            }
        } catch (error) {
            outputDiv.innerHTML = `<p>Error: ${error.message}</p>`;
            console.error("Error:", error.message);
        }
    }

    window.onload = () => {
        fetchBatteryData();
        setInterval(updateElapsedTime, 1000);
        setInterval(fetchBatteryData, 10000);
    };
</script>
</body>
</html>


