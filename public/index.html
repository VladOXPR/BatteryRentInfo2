<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battery Rental Status</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 10px; /* Remove extra padding */
            margin: 0; /* Prevents unwanted shifting */
            background-color: #171717; /* Dark background */
            color: #FFFFFF; /* White text for contrast */
            height: 100vh; /* Full viewport height */
            overflow: hidden; /* Prevents any scrolling */ /* Centers content horizontally */
        }


        #output {
            margin: 20px 0;
        }

        .view-locations-btn {
            display: block; /* Make it take the full width */
            width: 100%; /* Full width minus 20px margin on each side */
            margin: 20px auto; /* Center the button and add top margin */
            padding: 10px 20px;
            font-size: 16px;
            color: white;
            background-color: #172229;
            border: 1px solid #1D2B34;
            border-radius: 10px;
            cursor: pointer;
        }


        .view-locations-btn:hover {
            background-color: #1D2B34;
        }

        #batteryIdDisplay {
            font-weight: bold;
            margin-top: 30px;
            font-weight: bold;
            font-size: 30px;
            color: #1F1F1F;
        }

        .sms-button {
            display: inline-block;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            text-decoration: none;
            cursor: pointer;
        }

        .sms-button:hover {
            background-color: #0056b3;
        }

        #elapsedTime {
            font-size: 75px; /* Make the text larger */
            font-weight: bold; /* Make the text bold */
            color: #FFFFFF; /* Gold color for visibility */; /* Dark background to make it stand out */
            padding: 5px 10px; /* Add some padding */
            border-radius: 5px; /* Slightly rounded corners */
            display: inline-block;
        }

        #amountPaid {
            font-size: 75px; /* Make the text larger */
            font-family: "Jersey 10", serif;
            font-weight: 400;
            font-style: normal; /* Make the text bold */
            color: #7DDB2A; /* Gold color for visibility */
            background-color: #000; /* Dark background to make it stand out */
            padding: 10px; /* Add some padding */
            border-radius: 10px; /* Slightly rounded corners */
            display: inline-block; /* Keep it inline but apply styles properly */
        }
    </style>
</head>
<body>
<div id="output"></div>
<button class="view-locations-btn" onclick="window.location.href='https://cuublocations.glide.page/dl/d0a5f4';">
    Return At Any Location
</button>

<p id="batteryIdDisplay"></p>

<script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.4.4/luxon.min.js"></script>
<script>
    const { DateTime } = luxon;
    let borrowTime = null;
    
    function convertChinaToChicagoTime(chinaTimeStr) {
        return chinaTimeStr ? DateTime.fromISO(chinaTimeStr, { zone: "Asia/Shanghai" }).setZone("America/Chicago") : null;
    }
    
    function getTimeElapsed(startTime) {
        if (!startTime) return "Invalid Time";
        const diff = DateTime.now().setZone("America/Chicago").diff(startTime, ['hours', 'minutes', 'seconds']);
        return `${diff.hours}:${diff.minutes}:${Math.floor(diff.seconds)}`;
    }
    
    function calculateAmountPaid(startTime) {
        if (!startTime) return "$0.00";
        return `$${(Math.ceil(DateTime.now().diff(startTime, 'hours').hours) * 3).toFixed(2)}`;
    }
    
    function updateElapsedTime() {
        if (borrowTime) {
            document.getElementById("elapsedTime").textContent = getTimeElapsed(borrowTime);
            document.getElementById("amountPaid").textContent = calculateAmountPaid(borrowTime);
        }
    }
    
    async function fetchBatteryData() {
        const batteryId = window.location.pathname.substring(1);
        const outputDiv = document.getElementById("output");
        const batteryIdDisplay = document.getElementById("batteryIdDisplay");
    
        if (!batteryId) {
            outputDiv.innerHTML = "<p><strong>No Battery ID provided in URL.</strong></p>";
            batteryIdDisplay.textContent = "";
            return;
        }
    
        batteryIdDisplay.textContent = `${batteryId}`;
        const host = window.location.hostname;
        const port = window.location.port ? `:${window.location.port}` : '';
        const apiUrl = `https://${host}${port}/api/battery/${batteryId}`;
    
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error("Battery not found.");
    
            const data = await response.json();
            outputDiv.innerHTML = "";
    
            if (data.pGhtime) {
                const chiReturnTime = convertChinaToChicagoTime(data.pGhtime);
                outputDiv.innerHTML = `<p><strong>Battery Returned:</strong> ${chiReturnTime ? chiReturnTime.toFormat("yyyy-MM-dd HH:mm:ss") : "Invalid Return Time"}</p>`;
            } else {
                borrowTime = convertChinaToChicagoTime(data.pBorrowtime);
                if (borrowTime) {
                    outputDiv.innerHTML = `
                        <p><strong></strong> <span id="elapsedTime">${getTimeElapsed(borrowTime)}</span></p>
                        <p><strong></strong> <span id="amountPaid">${calculateAmountPaid(borrowTime)}</span></p>
                    `;
                } else {
                    outputDiv.innerHTML = `<p><strong>Invalid Borrow Time</strong></p>`;
                }
            }
        } catch (error) {
            outputDiv.innerHTML = `<p>Error: ${error.message}</p>`;
            console.error("Error:", error.message);
        }
    }
    
    window.onload = () => {
        fetchBatteryData();
        setInterval(updateElapsedTime, 1000);
        setInterval(fetchBatteryData, 10000);
    };
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Jersey+10&display=swap" rel="stylesheet">
</body>
</html>
